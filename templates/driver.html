<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Driver Interface</title>
    <style>
        #map {
            height: 400px;
            width: 100%;
        }
        #acceptRide {
            display: none;
        }
        #rejectRide{
            display: none;
        }
        #roomNumber {
            display: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
</head>
<body>
    <h2>Driver Interface</h2>
    <div id="map"></div> <!-- Driver's map -->
    <div id="address"></div>
    <div id="ridesContainer">
    </div>
    <p id="roomNumber">Room Number: <span id="room"></span></p>
    <form action="/driver" method="post" id="privateMessageForm">
        <input type="submit" id="privatemessage" value="Private Message" style="display: none">
    </form>
    

    <script>
        var map, geocoder, userLocation, socket;
        let rides = [];
        socket = io();
        var rightname, origin, destination = '461 Clementi Rd, Singapore 599491', date, time, seat;
        var waypoints = [];
        var roomNumber = "{{ room }}";
        let rideIndex, selectedRide;
        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 20,
                center: {lat: 1.3521, lng: 103.8198} 
            });
            geocoder = new google.maps.Geocoder();
            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer();
            /*directionsRenderer = new google.maps.DirectionsRenderer({
                suppressMarkers: true // Suppress default markers
            })*/
            directionsRenderer.setMap(map);

            // Get user's geolocation
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(userLocation); // Set the center of the map to the user's location
                    var marker = new google.maps.Marker({
                        position: userLocation,
                        map: map,
                        title: 'You are here'
                    });
                    calculateAndDisplayRoute(userLocation, destination, waypoints);
                }, function() {
                    // Handle geolocation errors
                    console.log('Error: The Geolocation service failed.');
                });
            } else {
                // Browser doesn't support geolocation
                console.log('Error: Your browser doesn\'t support geolocation.');
            }
        }

        socket.on('ride_offered', function(data) {
            console.log('ride_offered:', data);
            rightname = data.username
            let newRide = {
                username: data.username,
                origin: data.origin,
                date: data.date,
                time: data.time,
                seat: data.seat,
                gender: data.gender
            };
            rides.push(newRide);
            console.log(data.username)
            
            // Update the display with all rides
            displayRides(); 
        });

        socket.on('ride_cancel', function(data) {
            var riderlocation = data.riderlocation;
            var ridername = data.ridername;
            console.log('riderlocation: ', riderlocation)
            console.log('Current rides:', rides);
            waypoints = waypoints.filter(waypoint => waypoint.location !== riderlocation); 
            calculateAndDisplayRoute(userLocation, destination, waypoints);
            // Refresh the display of rides
            const rideIndex = rides.findIndex(ride => ride.username === ridername);

            // Check if the ride was found
            if (rideIndex !== -1) {
            // Ride found, remove it from the array
            const removedRide = rides.splice(rideIndex, 1);
            console.log('Removed ride:', removedRide);
            } else {
            // No ride found with that username
            console.log('No ride found for username:', usernameToRemove);
            }
            displayRides();
        });

        document.getElementById('ridesContainer').addEventListener('click', function(event) {
            if (event.target.className.includes('acceptRide')) {
                // Retrieve the index of the ride associated with the clicked button
                rideIndex = event.target.getAttribute('data-ride-index');
                selectedRide = rides[rideIndex]; // Access the ride data using the retrieved index

                // Example action: Log the selected ride's origin (You would replace this with your actual functionality)
                console.log('Accepting ride from:', selectedRide.origin);

                // Push the origin of the accepted ride into the waypoints array
                waypoints.push({
                    location: selectedRide.origin,
                    stopover: true
                });
                console.log(waypoints);
                calculateAndDisplayRoute(userLocation, destination, waypoints);
                // Hide the "Accept" button and show the "Private Message" option
                event.target.style.display = 'none'; // Hide the clicked "Accept" button
                event.target.nextElementSibling.style.display = 'none'; // Hide the corresponding "Reject Ride" button
                const privateMessageButton = event.target.nextElementSibling.nextElementSibling; // Assuming "Private Message" is after "Reject Ride"
                privateMessageButton.style.display = 'block';
                const cancelRideButton = privateMessageButton.nextElementSibling; // Selects the "Cancel Ride" button based on its position
                cancelRideButton.style.display = 'block';
                // Geocode the user's location (assuming userLocation is globally accessible)
                geocoder.geocode({ 'location': userLocation }, function(results, status) {
                    if (status === 'OK') {
                        if (results[0]) {
                            var address = results[0].formatted_address;
                            
                            // Emit the "accept_ride" event via Socket.io with necessary data
                            console.log('Emitting accept_ride event', {
                                location: userLocation,
                                driverAddress: address,
                                room: roomNumber // Assuming roomNumber is globally accessible
                            });
                            socket.emit('accept_ride', {
                                location: userLocation,
                                driverLocation: address,
                                room: roomNumber
                            })
                            
                        } else {
                            console.log('No results found for reverse geocoding.');
                        }
                    } else {
                        console.log('Reverse geocoder failed due to: ' + status);
                    }
                });
            } else if (event.target.className.includes('rejectRide')) {  
                // Get the index of the ride to be removed
                const rideIndex = parseInt(event.target.getAttribute('data-ride-index'), 10);
                // Log the action
                console.log('Ride rejected for index:', rideIndex);
                // Remove the ride from the array
                rides.splice(rideIndex, 1);
                // Refresh the display of rides
                displayRides();
            }else if (event.target.className.includes('privateMessage')) {
                // Submit the form when the Private Message button is clicked
                document.getElementById('privateMessageForm').submit();
            }
            else if (event.target.className.includes('cancel')) {
                // Get the index of the ride to be removed
                const rideIndex = parseInt(event.target.getAttribute('data-ride-index'), 10);
                // Log the action
                console.log('Ride rejected for index:', rideIndex);
                // Remove the ride from the array
                rides.splice(rideIndex, 1);
                // location to remove
                const locationToRemove = selectedRide.origin;

                // Remove the waypoint with the matching location
                waypoints = waypoints.filter(waypoint => waypoint.location !== locationToRemove); 
                calculateAndDisplayRoute(userLocation, destination, waypoints);
                // Refresh the display of rides
                displayRides();
                socket.emit('cancel_ride', {
                    rightname: rightname,
                    
                })
            }
        });

        function displayRides() {
            // Select the container where the rides will be displayed
            let ridesContainer = document.getElementById('ridesContainer');
            
            // Clear the container
            ridesContainer.innerHTML = '';
            
            // Iterate over the rides array
            rides.forEach(function(ride, index) {
                // Create a new div element for each ride
                let rideInfoDiv = document.createElement('div');
                rideInfoDiv.innerHTML = `
                    <p>Name: <span>${ride.username}</span></p>
                    <p>Passenger Location: <span>${ride.origin}</span></p>
                    <p>Destination Location: <span>${ride.destination}</span></p>
                    <p>Date: <span>${ride.date}</span></p>
                    <p>Time: <span>${ride.time}</span></p>
                    <p>Seats available: <span>${ride.seat}</span></p>
                    <button class="acceptRide" data-ride-index="${index}">Accept Ride</button>
                    <button class="rejectRide" data-ride-index="${index}">Reject Ride</button>
                    <button class="privateMessage" data-ride-index="${index}" style="display: none;">Private Message</button>
                    <button class="cancel" data-ride-index="${index}" style="display: none;">Cancel Ride</button>
                    <hr>`; // The <hr> creates a horizontal line for visual separation between rides


                // Append the new div to the container
                ridesContainer.appendChild(rideInfoDiv);
            });
        }

        function calculateAndDisplayRoute(origin, destination, waypointsArray) {
            var request = {
                origin: origin, // Can be a LatLng object or string
                destination: destination, // Can be a LatLng object or string
                travelMode: 'DRIVING',
                waypoints: waypointsArray // No need to map over it again
            };

            // Only include the waypoints property if there are waypoints
            if (waypointsArray && waypointsArray.length > 0) {
                request.optimizeWaypoints = true;
            }

            directionsService.route(request, function(response, status) {
                if (status === 'OK') {
                    directionsRenderer.setDirections(response);
                } else {
                    console.error('Directions request failed due to ' + status);
                }
            });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDWGspYJlGaBszG-0PYcN41cCCGPpEnZ5s&callback=initMap" async defer></script>
</body>
</html>